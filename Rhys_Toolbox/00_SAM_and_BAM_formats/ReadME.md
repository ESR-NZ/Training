#### Author: Rhys White ([@RhysTWhite](https://twitter.com/RhysTWhite))
#### Affiliations: Institute of Environmental Science and Research - ESR

# Rhys' roadmap to SAM: a tutorial for navigating read-mapping files

Table of contents
=================

<!--ts-->
   * [Prerequisites](#prerequisites)
   * [Introduction](#introduction)
      * [What is a SAM file?](#what-is-a-sam-file)
      * [What is a BAM file?](#what-is-a-bam-file)
   * [Let's get started...](#lets-get-started)
      * [How to view a SAM or BAM file](#how-to-view-a-sam-or-bam-file)
   * [Why have I learnt this?](#why-have-i-learnt-this)
   * [Final notes](#final-notes)
   * [Data availability](#data-availability)
<!--te-->

## Prerequisites
Before we begin, you should have a basic understanding of genomics and the concept of DNA sequencing. You should also be familiar with the command line and have access to a Unix-based operating system (such as Linux or macOS). The focus of this tutorial is on a tool called `samtools`, and you can find its manual here: [http://www.htslib.org/doc/samtools.html](http://www.htslib.org/doc/samtools.html)

## Introduction

Read-mapping is a bioinformatics method that involves aligning and mapping sequence reads derived from next-generation sequencing technologies to a reference genome. Its primary purpose is to identify the location and variations of the reads relative to a reference genome.

In the process of read-mapping, a modified pairwise alignment method is utilised to assign sequence reads to a position in a reference sequence. However, implementing a complete Smith-Waterman optimal alignment is not feasible due to the enormous volume of reads generated by modern sequencing technologies; thus, various heuristics have been developed as a practical solution to address this issue. After the completion of a read-mapping approach, a representation of the reads that correspond to the reference sequence is generated, displaying any variations between the consensus of the mapped reads and the reference sequence. 

SAM (Sequence Alignment/Map) is a widely used file format for storing sequence alignment information in genomics, created to facilitate the 1000 Genomes project ([www.internationalgenome.org/](www.internationalgenome.org/)).

In this tutorial, we'll explore the SAM file format and learn how to read and interpret the sequence data that has been mapped to a reference. In addition, this tutorial will cover fundamental techniques for manipulating SAM/BAM read-mapping files and introduce several critical Unix commands.

### What is a SAM file?

A SAM file is a text file that stores information about sequence alignments. Generated by aligners such as [Bowtie](https://bowtie-bio.sourceforge.net/index.shtml) and [Burrows-Wheeler Aligner (BWA)](https://bio-bwa.sourceforge.net/), a SAM file represents the alignment of reads (DNA sequences) to a reference genome. The SAM format has two sections: a header section and an alignment section. The header section of the SAM file holds metadata about the reference genome and alignment procedure, whereas the alignment section comprises the alignment information for each read.

### What is a BAM file?

A BAM (Binary Alignment Map) file format is a binary representation of the SAM format used to store DNA sequencing data. As a result, the data is compressed to reduce storage requirements, and the binary format allows for faster processing and retrieval of information. 

## Let's get started...

### How to view a SAM or BAM file

To read a SAM file, you can use a text editor or a command-line tool like [SAMtools](http://www.htslib.org/). Let's dive right in and observe what reads appear as when mapped to a genomic sequence.

#### Let's start with a BAM!

##### Getting the data
Note: The data is ~20 MB. To download the data, please run these commands:

```bash
# Download the reference assembly fasta file:
wget https://raw.githubusercontent.com/ESR-NZ/Training/main/Rhys_Toolbox/00_SAM_and_BAM_formats/Chlamydia_horse.fasta
```

```bash
# Download the BAM format file:
wget https://raw.githubusercontent.com/ESR-NZ/Training/main/Rhys_Toolbox/00_SAM_and_BAM_formats/Chlamydia_mapped.bam
```

You have been given two files: a read-mapping file in BAM format named `Chlamydia_mapped.bam` and a reference sequence in fasta format named `Chlamydia_horse.fasta`. To begin, create a directory called `mapping` and move both files into it. Afterwards, navigate to the `mapping` folder:


```bash
# Make a directory called mapping:
mkdir mapping
```

```bash
# Move the BAM format file into your mapping directory:
mv /path/to/Chlamydia_mapped.bam mapping/.
```

```bash
# Move the fasta format file into your mapping directory:
mv /path/to/Chlamydia_horse.fasta mapping/.
```

```bash
# Change directory to your mapping directory
cd mapping
```

To confirm that both files are present in your current working directory, check for their existence using the following command:

```bash
# Directory listing
ls
```

To view the information in the BAM file, we must first create an index for it. The index helps us to find the location of the genetic information we need quickly, which speeds up the analysis process. To create the index, we use a specific command:

```bash
# Index the BAM file:
samtools index Chlamydia_mapped.bam
```

We can now begin using the `samtools` viewer. You can access the manual page for `samtools tview` by following this link: [http://www.htslib.org/doc/samtools-tview.html](http://www.htslib.org/doc/samtools-tview.html). We can use the `samtools` viewer using the following command: 

```bash
# Open the samtools viewer:
samtools tview Chlamydia_mapped.bam Chlamydia_horse.fasta
```

The `samtools tview` command launches an interactive text-based viewer that displays the reference genome and mapped reads. This allows you to examine the reads' alignment to the reference genome visually. With `samtools tview`, you can navigate the genome, zoom in and out, view the base qualities, and highlight specific regions of interest. Additionally, the viewer provides information about the read name, read sequence, quality score, and alignment position.

The initial row in the viewer represents the reference genome sequence. The subsequent row, which is underlined, indicates the consensus sequence derived from all the mapped reads. Typically, the consensus sequence for each column is determined by selecting the most commonly occurring nucleotide or base. Pressing the question mark (?) key displays a brief help screen. To exit the help screen, press the `q` key to quit.

#### What about SAM!

The `samtools` program provides a `view` command that allows you to extract the contents of a BAM file in SAM format, or convert a SAM file to BAM format.

```bash
# To view the BAM file:
samtools view Chlamydia_mapped.bam | less -S
```

You will observe the output on your screen in tab-separated text format. You can press the `q` key to quit the `less` command line utility.

Using output redirection, we can write the content to a file called `Chlamydia_mapped.sam`.

```bash
samtools view Chlamydia_mapped.bam > Chlamydia_mapped.sam
```

To read a SAM file, you can use a text editor or a command-line tool like `SAMtools`. Let's take a look at the first five lines in your SAM file:

```bash
# To view the BAM file:
head -n 5 Chlamydia_mapped.sam | less -S
```

You should see a similar output to this on your screen:

```
BF_amazon_parrot13-127808	99	9945_foetus	10	60	100M	=	295	385	ACTCTATCTTTTTCAGAAGTTGTGGAAAGTGTTGAAGGAATGTAAAAATGAGCTCATTAGCGTTGAGTCGACGACCTCGTAGAAATAGAAGAACTGAGGC	CBCCCGGGGGGGGGGGGCCGGGGGGGCEGGG>GBDGGGGGGGGGGGGGGGGGGFG/FGGGGGFGBG/GDGECGGE>GGGF.?>GGG8G?GGGGGEGGGG<	NM:i:0	MD:Z:100	MC:Z:100M	AS:i:100	XS:i:0
BF_amazon_parrot13-191146	99	9945_foetus	14	60	100M	=	280	366	TATCTTTTTCAGAAGTTGTGGAAAGTGTTGAAGGAATGTAAAAATGAGCTCATTAGCGTTGAGTCGACGACCTCGTAGAAATAGAAGAACTGAGGCAATT	CBCCCGDFCGGGCGGG1FBGGGGDGGEGGGGFAGGGGGGGGGGGGGGGGGGGGGGGGGGGG1GG9GFGGGGGGGGGGGGGGGGGGGGCGGGGGGDDGGGG	NM:i:0	MD:Z:100	MC:Z:100M	AS:i:100	XS:i:0
BF_amazon_parrot13-48918	163	9945_foetus	25	60	100M	=	355	430	GAAGTTGTGGAAAGTGTTGAAGGAATGTAAAAATGAGCTCATTAGCGTTGAGTCGACGACCTCGTAGAAATAGAAGAACTGAGGCAATTCGTGATTTGGT	ABCBBGF=>GGGG/GGGGGGG1GGGG1GGGGG=GGGGDGDGGGGG:GGGFGGGGGGEGGGGGGGGGGGCGDGG/GGGGGGFEGG0G>GGGGGE0FFGGGG	NM:i:0	MD:Z:100	MC:Z:100M	AS:i:100	XS:i:0
BF_amazon_parrot13-124376	163	9945_foetus	38	60	100M	=	241	303	GTGTTGAAGGAATGTAAAAATGAGCTCATTAGCGTTGAGTCGACGACCTCGTAGAAATAGAAGAACTGAGGCAATTCGTGATTTGGTATCTGAAACTTCT	C@BC?GG>GGGGGGGFG1@GGGGGGGGCGG0G/>GGGGGGGGGEG<GGG/GGFGGGGFGGGGGG1GG1G1GGGG>GGDG0GGGGCGGGGGGGFGGCGGGG	NM:i:0	MD:Z:100	MC:Z:100M	AS:i:100	XS:i:0
BF_amazon_parrot13-33382	163	9945_foetus	52	60	100M	=	295	343	TAAAAATGAGCTCATTAGCGTTGAGTCGACGACCTCGTAGAAATAGAAGAACTGAGGCAATTCGTGATTTGGTATCTGAAACTTCTTTATTACCTCAGGA	3ACCCFGGGGGGFGGGGGGGGGGGGGGGCCGGGGDGDGGGGGBGGGGGGGFGGGGGGGG@G0GG<EFGGFGGGGGCGGC0GEGGFGGGGDGGGFGGGDGG	NM:i:0	MD:Z:100	MC:Z:100M	AS:i:100	XS:i:0
```

Within the file's alignment section, there are two alignment records present, one for each read. Each of these records comprises 11 mandatory fields as well as a few optional fields. It's important to note that the mandatory fields include:

```
Index.	Field name:	Description
1.	QNAME:	Query template NAME. This is a unique identifier for the read that was aligned
2.	FLAG:	A set of bitwise flags that describe various properties of the alignment, such as whether it's paired-end or single-end, whether it's mapped, whether it's reverse-complemented, etc
3.	RNAME:	Reference sequence NAME. This is the name of the chromosome or contig to which the read was aligned
4.	POS:	1-based leftmost mapping POSition of the first matching base
5.	MAPQ:	MAPping Quality. This is a Phred-scaled score that represents the probability that the read was incorrectly mapped
6.	CIGAR:	Compact Idiosyncratic Gapped Alignment Report. This describes how the read aligns to the reference sequence, including any gaps or insertions
7.	RNEXT:	RefereNce sequence name of the mate/next read. For paired-end reads, this gives the name of the chromosome or contig to which the mate was aligned
8.	PNEXT:	Position of the mate/next read. For paired-end reads, this gives the position of the mate on the reference sequence
9.	TLEN:	Template LENgth. This is the inferred insert size (i.e. distance between the paired-end reads) for paired-end reads
10.	SEQ:	The sequence of the read
11.	QUAL:	The quality scores for the read
```

The optional fields can contain additional information about the alignment, such as alignment score, number of mismatches, and so on.

#### Interpreting the SAM file

Now that we know how to read a SAM file, let's interpret the information in the file. In the example SAM file above, we can see that the read `BF_amazon_parrot13-127808` has been mapped to `9945_foetus` at position `10` with a MAPQ score of `60`. The CIGAR string `100M` means that the read aligns perfectly to the reference genome for a region of 100 bases.

Similarly, the read `BF_amazon_parrot13-191146` has been mapped to `9945_foetus` at position `14` with a MAPQ score of `60`. Again, the CIGAR string `100M` means that the read aligns perfectly to the reference genome for a region of 100 bases. 

More information about the FLAG and CIGAR field is below.


#### Understanding the FLAG field in a SAM output

The FLAG field is a 16-bit field represented as a decimal number. Each bit in the field represents a different property of the read alignment. Therefore, to interpret the FLAG value, we need to convert it to binary and examine each bit.

To convert the FLAG value in `samtools` into binary format, you will need to convert the decimal value of the FLAG field to binary using the built-in `bin()` function in Python. For example, if the decimal value of the FLAG field is 99, you would convert it to binary using the following code:

```python
>>> bin(99)
```
Your output should look like this:
```
0b1100011
```
The prefix `0b` indicates that the value is in binary format.

Here is another example of a FLAG field in binary format:

```
101000
```

##### Common FLAG Values

Here are some common FLAG values and what they represent:

```
Hex Code:	Description
0x0001: read is the first read in a pair
0x0002: read is the second read in a pair
0x0004: read is unmapped
0x0008: mate is unmapped
0x0010: strand of the query (0 for forward; 1 for reverse strand)
0x0020: mate is reverse-complemented
0x0040: read is the first read in a proper pair
0x0080: read is the second read in a proper pair
0x0100: read is a secondary alignment
0x0200: read fails platform/vendor quality checks
0x0400: read is a PCR or optical duplicate
```

Each position in the binary string corresponds to a different bit, as follows:

```
1 0 1 0 0 0
^ ^ ^ ^ ^ ^
| | | | | |
| | | | | +-- bit 0x001: template having multiple segments in sequencing
| | | | +---- bit 0x004: each segment properly aligned according to the aligner
| | | +------ bit 0x008: segment unmapped
| | +-------- bit 0x020: next segment in the template unmapped
| +---------- bit 0x040: SEQ being reverse complemented
+------------ bit 0x080: SEQ of the next segment in the template being reversed
```

In this example, the FLAG field has the decimal value of 40 + 8 + 2 = 50. This means that the read:

- is paired-end (bit 0x001 is unset)
- is properly aligned (bit 0x004 is set)
- is not unmapped (bit 0x008 is unset)
- the next segment in the template is unmapped (bit 0x020 is set)
- the read is reverse-complemented (bit 0x040 is set)
- the next segment in the template is also reverse-complemented (bit 0x080 is set)

There are several tools and commands that can be used to manipulate and work with FLAG fields in SAM files. For example:

`samtools view -f` can be used to filter out reads based on their FLAG values. For example, `samtools view -f 4` would filter out all unmapped reads.

`samtools flagstat` can be used to generate summary statistics about the alignments in a SAM file, including the number and percentage of reads that pass certain quality control checks (e.g. properly aligned, paired-end, etc.).

#### Understanding the CIGAR field in a SAM output

The CIGAR field in SAM files provides a compact representation of the alignment of a read to the reference genome. It describes the sequence of operations (i.e., match/mismatch, insertion, deletion, etc.) needed to transform the read sequence into the reference sequence.

The CIGAR field is a string of characters that represents the alignment of the read. Each character in the CIGAR string corresponds to an operation that was performed during the alignment. The possible operations are:

```
Operation - Description
M - alignment match or mismatch
I - insertion to the reference
D - deletion from the reference
N - skipped region from the reference
S - soft clipping (sequence present in the read but not aligned to the reference)
H - hard clipping (sequence not present in the read or reference)
P - padding (silent deletion from padded reference)
= - match
X - mismatch
```

In the CIGAR string, the digit before each character indicates the number of consecutive bases that the operation applies to. For instance, if the CIGAR string is `50M2D10M`, it means that the read aligns to the reference for the first 50 bases, then has 2 deletions from the reference, and then matches the reference sequence again for the next 10 bases.

Here are some additional things to keep in mind when working with CIGAR strings:

- The total length of the alignment can be calculated by summing the lengths of all the segments that are not clipped or skipped (i.e., those with the M, I, and D codes)
- Insertions and deletions are always relative to the reference sequence. For example, an insertion in the read corresponds to a deletion in the reference
- Soft clipping is used to indicate that some portion of the read could not be aligned to the reference, but should still be included in the final alignment. Soft clipped bases are present in the SEQ field of the SAM record, but are not included in the MD or NM tags.
- Hard clipping is used to indicate that some portion of the read is not present in the final alignment and should be ignored
- The CIGAR string can be used to infer the position and length of any insertions or deletions relative to the reference sequence


## Why have I learnt this?

Accurately identifying single-nucleotide variants (SNVs), insertions and deletions (indels), and structural genomic variants (SVs) is a challenging undertaking. Differentiating between genuine variant positions and errors introduced during sequencing or mapping is a daunting challenge when analysing sequence read-mapping data. 

## Whakamihi! You did it!

That's it for this tutorial on SAM files! If you have any further questions, feel free to ask.


###### Final notes

<sup> This tutorial uses example paired-end short-read sequencing data from our phylogenomic study of *Chlamydia psittaci* sequence type (ST)24. I invite you to read our publication if you find this data intriguing: <sup>


<sub> &emsp; **White RT**, Jelocnik M, Klukowski N, Haque MH, Sarker S. The first genomic insight into *Chlamydia psittaci* sequence type (ST)24 from a healthy captive psittacine host in Australia demonstrates evolutionary proximity with strains from psittacine, human, and equine hosts. *Veterinary Microbiology* 2023;109704 doi: [10.1016/j.vetmic.2023.109704](https://doi.org/10.1016/j.vetmic.2023.109704)<sub> 

###### Data availability

<sub> Sequence read data has been submitted to the National Center for Biotechnology Information (NCBI) Sequence Read Archive (SRA) under BioProject [PRJNA888783](https://www.ncbi.nlm.nih.gov/bioproject/?term=PRJNA888783) <sub>

<sub> Raw Illumina sequence read data have been deposited to the NCBI SRA under the accession number [SRR21848900](https://www.ncbi.nlm.nih.gov/sra/?term=PRJNA888783) <sub>

<sub> In addition, the high-quality assembly has been deposited to the NCBI GenBank database under the accession numbers [CP110211](https://www.ncbi.nlm.nih.gov/nuccore/CP110211.1) and [CP110212](https://www.ncbi.nlm.nih.gov/nuccore/CP110212.1) <sub> 
